name: Dependency Vulnerability Scan

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  dependency-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install
      working-directory: juice_shop

    - name: Run npm audits
      run: |
        npm audit --json > npmaudit-report.json
        cat juice_shop/npmaudit-report.json
      working-directory: juice_shop
      continue-on-error: true

    # Install Snyk CLI and authenticate
    - name: Install Snyk
      run: |
        npm install -g snyk
        snyk auth ${{ secrets.SNYK_TOKEN }}

    # Run Snyk test and generate report
    - name: Run Snyk dependency scan
      id: snyk
      working-directory: juice_shop
      continue-on-error: true
      run: |
        snyk test --json > snyk-report.json || true

    - name: Upload Snyk report
      uses: actions/upload-artifact@v4
      with:
        name: snyk-report
        path: juice_shop/snyk-report.json

    - name: Upload audit reports
      uses: actions/upload-artifact@v4
      with:
        name: audit-report
        path: juice_shop/npmaudit-report.json

    - name: Generate collapsible vulnerability summary
      id: summary
      run: |
        echo "================== Vulnerability Summary =================="

        SUMMARY=""

        # Helper function to create collapsible section per severity
        make_section() {
          local FILE="$1"
          local TOOL="$2"
          local SEVERITY="$3"

          COUNT=$(jq "[.vulnerabilities[]? | select(.severity==\"$SEVERITY\")] | length" "$FILE")
          if [ "$COUNT" -gt 0 ]; then
            echo "<details>"
            echo "<summary>$(echo $TOOL) - $SEVERITY ($COUNT)</summary>"
            echo ""
            jq -r --arg tool "$TOOL" --arg sev "$SEVERITY" '
              .vulnerabilities[]? 
              | select(.severity == $sev) 
              | "- **\(.name // .packageName)** (\(.severity)) – [\(.title // "N/A")](\(.url // ""))"
            ' "$FILE"
            echo ""
            echo "</details>"
          fi
        }

        # Create sections for npm audit
        SUMMARY+="### npm Audit Report"
        for sev in critical high moderate low; do
          SUMMARY+=$(make_section juice_shop/npmaudit-report.json "npm audit" "$sev")
        done

        # Create sections for Snyk
        SUMMARY+="\n### Snyk Scan Report"
        for sev in critical high moderate low; do
          SUMMARY+=$(make_section juice_shop/snyk-report.json "Snyk" "$sev")
        done

        # Fallback if empty
        if [ -z "$SUMMARY" ]; then
          SUMMARY="✅ No vulnerabilities found!"
        fi

        # Escape for GitHub Actions
        echo "summary<<EOF" >> $GITHUB_OUTPUT
        echo "$SUMMARY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT


    - name: Comment on Pull Request
      uses: peter-evans/create-or-update-comment@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ## Dependency Vulnerability Report
          
          ${{ steps.summary.outputs.summary }}

    - name: Fail if critical or high severity found
      working-directory: juice_shop
      shell: bash
      run: |
        NPM_HIGH=$(jq '[.vulnerabilities[]? | select(.severity=="high" or .severity=="critical")] | length' npmaudit-report.json)
        echo "npm audit - High/Critical count: $NPM_HIGH"

        # Check Snyk
        SNYK_HIGH=$(jq '[.vulnerabilities[]? | select(.severity=="high" or .severity=="critical")] | length' snyk-report.json)
        echo "Snyk - High/Critical count: $SNYK_HIGH"

        total_vuln=$((NPM_HIGH + SNYK_HIGH))
        if [ "total_high" -gt 0 ]; then
          echo "❌ High or critical vulnerabilities detected!"
          exit 1
        fi

    - name: Notify Slack on failure
      if: failure()  # Only runs when the previous job fails
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        PAYLOAD=$(jq -n --arg repo "${{ github.repository }}" \
                         --arg url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
                         --arg branch "${{ github.ref_name }}" \
                         --arg summary "${{ env.summary }}" \
        '{
          "attachments": [
            {
              "color": "#ff0000",
              "title": "⚠️ Dependency Check Failed with snyk and npm audit",
              "fields": [
                {"title": "Repository", "value": $repo, "short": true},
                {"title": "Branch", "value": $branch, "short": true},
                {"title": "Details", "value": $summary, "short": false}
              ],
              "actions": [
                {
                  "type": "button",
                  "text": "View Workflow Run",
                  "url": $url
                }
              ]
            }
          ]
        }')

        curl -X POST -H 'Content-type: application/json' \
          --data "$PAYLOAD" \
          "$SLACK_WEBHOOK_URL"


