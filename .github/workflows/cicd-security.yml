name: Security Pipeline

on:
  push:
    branches: [ "master" ]
    paths-ignore: 
      - 'devsecops_proj/security_reports/**'
      - 'devsecops_proj/devsecops_project_guideline/**'
      - 'devsecops_proj/docs/**'
      - 'devsecops_proj/infrastructure/**'
  pull_request:
    branches: [ "master" ]
    paths-ignore: 
      - 'devsecops_proj/security_reports/**'
      - 'devsecops_proj/devsecops_project_guideline/**'
      - 'devsecops_proj/docs/**'
      - 'devsecops_proj/infrastructure/**'
  workflow_dispatch:

jobs:

  UnitTest:
    name: Run unit test with npm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Install dependencies
        working-directory: juice_shop
        run: npm install

      - name: Build Juice Shop
        working-directory: juice_shop
        run: npm run build:frontend

  SAST_Scan_Semgrep:
    name: Run Semgrep SAST
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Semgrep
        run: pip install semgrep
        working-directory: juice_shop

      - name: Ensure reports folder
        run: mkdir -p juice_shop/reports
        working-directory: juice_shop

      - name: Run Semgrep Scan
        continue-on-error: true
        run: |
          semgrep --config=auto --exclude node_modules --json > juice_shop/reports/semgrep-report.json || true
          jq '[.results // [] | .[] | select(.extra.severity=="ERROR" or .extra.severity=="HIGH")] | length' juice_shop/reports/semgrep-report.json > juice_shop/reports/semgrep_fail.txt
        working-directory: juice_shop

      - name: Upload Semgrep artifact
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-reports
          path: juice_shop/reports/semgrep-report.json

  Dependency_Scan:
    name: Run dependency scan with Snyk
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Snyk
        run: |
          npm install -g snyk
          snyk auth ${{ secrets.SNYK_TOKEN }}

      - name: Ensure reports folder
        run: mkdir -p juice_shop/reports

      - name: Run Snyk Scan
        continue-on-error: true
        working-directory: juice_shop
        run: |
          snyk test --json > reports/snyk-report.json || true
          jq '[.vulnerabilities // [] | .[] | select(.severity=="high" or .severity=="critical")] | length' reports/snyk-report.json > reports/snyk_fail.txt

      - name: Upload Snyk artifact
        uses: actions/upload-artifact@v4
        with:
          name: snyk-reports
          path: juice_shop/reports/snyk-report.json

  Secret_Scan:
    name: Run secrets scan with Gitleaks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure reports folder
        run: mkdir -p juice_shop/reports

      - name: Run Gitleaks
        uses: zricethezav/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: detect --source juice_shop --report-format json --report-path juice_shop/reports/gitleaks-report.json

      - name: Upload Gitleaks artifact
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-reports
          path: juice_shop/reports/gitleaks-report.json

  Container_Scan:
    name: Run Trivy container scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          cd juice_shop
          docker build -t juice-shop:latest .

      - name: Ensure reports folder
        run: mkdir -p juice_shop/reports

      - name: Scan container with Trivy
        run: |
          trivy image --format json -o juice_shop/reports/trivy-report.json juice-shop:latest || true
          jq '[.Results[]? | .Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' juice_shop/reports/trivy-report.json > juice_shop/reports/trivy_fail.txt

      - name: Upload Trivy artifact
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: juice_shop/reports/trivy-report.json

  DAST_Scan:
    name: Run DAST scan with ZAP
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Ensure reports folder
        run: mkdir -p zap-reports

      - name: Start Juice Shop container
        run: |
          docker run -d --name juice --network bridge -p 3000:3000 bkimminich/juice-shop
          for i in {1..30}; do
            if curl -sSf http://localhost:3000 | grep -q "OWASP Juice Shop"; then break; fi
            sleep 2
          done

      - name: Run ZAP baseline scan
        run: |
          docker run --rm --network bridge -v ${{ github.workspace }}/zap-reports:/zap/wrk ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://juice:3000 -r baseline.html -J baseline.json || true

      - name: Run ZAP full scan
        run: |
          docker run --rm --network bridge -v ${{ github.workspace }}/zap-reports:/zap/wrk ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://juice:3000 -r fullscan.html -J fullscan.json || true

      - name: Upload ZAP artifact
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            zap-reports/baseline.json
            zap-reports/fullscan.json

  Upload_To_DefectDojo:
    name: Upload All Scan Reports to DefectDojo
    runs-on: ubuntu-latest
    needs: [SAST_Scan_Semgrep, Dependency_Scan, Secret_Scan, Container_Scan, DAST_Scan]
    steps:
      - uses: actions/checkout@v4

      # Download all artifacts from previous jobs
      - uses: actions/download-artifact@v4
        with:
          name: semgrep-reports
          path: reports
      - uses: actions/download-artifact@v4
        with:
          name: snyk-reports
          path: reports
      - uses: actions/download-artifact@v4
        with:
          name: gitleaks-reports
          path: reports
      - uses: actions/download-artifact@v4
        with:
          name: trivy-reports
          path: reports
      - uses: actions/download-artifact@v4
        with:
          name: zap-reports
          path: reports

      - name: List all reports
        run: ls -la reports

      - name: Upload all reports to DefectDojo
        run: |
          for report in reports/*.json; do
            [ ! -f "$report" ] && continue
            case "$report" in
              *semgrep*) scan_type="Semgrep Scan" ;;
              *trivy*) scan_type="Trivy Scan" ;;
              *gitleaks*) scan_type="Gitleaks Scan" ;;
              *baseline*|*fullscan*) scan_type="ZAP Scan" ;;
              *) scan_type="Generic Findings Import" ;;
            esac
            echo "Uploading $report as $scan_type..."
            curl -s -X POST "${{ secrets.DD_API_URL }}/import-scan/" \
              -H "Authorization: Token ${{ secrets.DD_API_KEY }}" \
              -F "scan_type=$scan_type" \
              -F "file=@$report" \
              -F "engagement=${{ secrets.DD_ENGAGEMENT_ID }}" \
              -F "active=true" \
              -F "verified=true" \
              -F "close_old_findings=true" \
              -F "auto_create_context=true"
          done
        env:
          DD_API_URL: ${{ secrets.DD_API_URL }}
          DD_API_KEY: ${{ secrets.DD_API_KEY }}
          DD_ENGAGEMENT_ID: ${{ secrets.DD_ENGAGEMENT_ID }}
